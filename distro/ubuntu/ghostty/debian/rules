#!/usr/bin/make -f

export HOME = $(CURDIR)
DEB_VERSION := $(shell dpkg-parsechangelog -S Version)
UPSTREAM_VERSION := $(shell echo $(DEB_VERSION) | sed 's/ppa[0-9]*$$//')

%:
	dh $@

DEB_HOST_ARCH_CPU ?= $(shell dpkg-architecture -qDEB_HOST_ARCH_CPU)

# Select Zig binary based on architecture
ifeq ($(DEB_HOST_ARCH_CPU),amd64)
	ZIG_BIN = ./zig/x86_64/zig
	ZIG_ARCH = x86_64
else ifeq ($(DEB_HOST_ARCH_CPU),arm64)
	ZIG_BIN = ./zig/aarch64/zig
	ZIG_ARCH = aarch64
else
	$(error Unsupported architecture: $(DEB_HOST_ARCH_CPU))
endif

override_dh_auto_configure:
	# Rewrite theme URL to local tarball and update hash (themes are vendored in source package)
	test -f ghostty-themes.tgz || (echo "ERROR: ghostty-themes.tgz not found!" && exit 1)
	# Update URL to file:// 
	sed -i "s#https://github.com/mbadolato[^\"]*ghostty-themes.tgz#file://$(CURDIR)/ghostty-themes.tgz#g" build.zig.zon build.zig.zon.json 2>/dev/null || true
	# Update hash to match the fixed themes tarball (required for file:// URLs)
	sed -i '/\.iterm2_themes/,/}/ s|\.hash = "[^"]*"|.hash = "N-V-__8AANFEAwCzzNzNs3Gaq8pzGNl2BbeyFBwTyO5iZJL-"|' build.zig.zon 2>/dev/null || true
	dh_auto_configure

override_dh_auto_build:
	# Build with vendored Zig deps (offline)
	# --system flag tells Zig to use pre-fetched packages from zig-deps/p/
	ZIG_GLOBAL_CACHE_DIR=$(CURDIR)/zig-deps \
	DESTDIR=$(CURDIR)/debian/ghostty \
	./zig/$(ZIG_ARCH)/zig build \
		--prefix /usr \
		--system $(CURDIR)/zig-deps/p \
		-Dversion-string=$(UPSTREAM_VERSION) \
		-Doptimize=ReleaseFast \
		-Dcpu=baseline \
		-Dpie=true

override_dh_auto_install:
	ZIG_GLOBAL_CACHE_DIR=$(CURDIR)/zig-deps \
	DESTDIR=$(CURDIR)/debian/ghostty $(ZIG_BIN) build install \
		--prefix /usr \
		--system $(CURDIR)/zig-deps/p \
		-Doptimize=ReleaseFast \
		-Dcpu=baseline
	# Remove terminfo file that conflicts with ncurses-term (Ubuntu 25.04+)
	rm -f $(CURDIR)/debian/ghostty/usr/share/terminfo/g/ghostty

override_dh_auto_clean:
	rm -rf zig-cache zig-out .zig-cache
	dh_auto_clean
