#!/usr/bin/make -f

export DH_VERBOSE = 1

# Go build environment - use local directories (Launchpad build is sandboxed)
export GOCACHE = $(CURDIR)/.cache/go-build
export GOPATH = $(CURDIR)/.go
export HOME = $(CURDIR)

# Extract version from debian/changelog
DEB_VERSION := $(shell dpkg-parsechangelog -S Version)
# Get upstream version (strip ppaN suffix for native packages)
UPSTREAM_VERSION := $(shell echo $(DEB_VERSION) | sed 's/ppa[0-9]*$$//')

%:
	dh $@

override_dh_auto_build:
	# Source tarball is already included in source package (downloaded by build-source.sh)
	# Launchpad build environment has no internet access
	test -f cliphist.tar.gz || (echo "ERROR: cliphist.tar.gz not found!" && exit 1)
	tar -xzf cliphist.tar.gz

	# Build with Go using vendored dependencies (no internet access on Launchpad)
	cd cliphist-$(UPSTREAM_VERSION) && \
		go build -mod=vendor -ldflags="-s -w" -o cliphist

override_dh_auto_install:
	# Install binary
	install -Dm755 cliphist-$(UPSTREAM_VERSION)/cliphist \
		debian/cliphist/usr/bin/cliphist

override_dh_auto_clean:
	# Don't delete cliphist.tar.gz - it's part of the source package (native format)
	# Clean up extracted directory and Go cache
	rm -rf cliphist-$(UPSTREAM_VERSION)
	rm -rf .cache .go
	dh_auto_clean
