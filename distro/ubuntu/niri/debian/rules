#!/usr/bin/make -f

export DH_VERBOSE = 1

# Rust build environment - use local directories (Launchpad build is sandboxed)
export CARGO_HOME = $(CURDIR)/.cargo

# Number of parallel jobs
NCPU := $(shell nproc)

# Extract version from debian/changelog
DEB_VERSION := $(shell dpkg-parsechangelog -S Version)
# Get upstream version (strip -1ppa1 suffix)
UPSTREAM_VERSION := $(shell echo $(DEB_VERSION) | sed 's/-[^-]*$$//')
# Strip ppa suffix
# Examples: 0.1.10ppa1 -> 0.1.10
BASE_VERSION := $(shell echo $(UPSTREAM_VERSION) | sed 's/ppa[0-9]*$$//')

%:
	dh $@

override_dh_auto_build:
	# Source is already included in source package (downloaded by build-source.sh)
	# Launchpad build environment has no internet access
	test -d niri-$(BASE_VERSION) || (echo "ERROR: niri-$(BASE_VERSION) source directory not found!" && exit 1)

	# Fix vendor checksums: preserve package hash, clear file-level checksums
	# This allows Cargo to work even if .orig/.rej files are present or removed
	for checksum in niri-$(BASE_VERSION)/vendor/*/.cargo-checksum.json; do \
		if [ -f "$$checksum" ]; then \
			pkg=$$(cat "$$checksum" | grep -o '"package":"[^"]*"' | cut -d'"' -f4); \
			echo "{\"files\":{},\"package\":\"$$pkg\"}" > "$$checksum"; \
		fi; \
	done

	# Build with cargo using vendored dependencies (no internet access on Launchpad)
	cd niri-$(BASE_VERSION) && \
		cargo build --offline --release --features default -j$(NCPU)

	# Generate shell completions
	cd niri-$(BASE_VERSION) && \
		for shell in bash fish zsh; do \
			./target/release/niri completions $$shell > $$shell-completions; \
		done

override_dh_auto_install:
	# Install binary
	install -vDm755 niri-$(BASE_VERSION)/target/release/niri \
		debian/niri/usr/bin/niri

	# Install niri-session
	install -vDm755 niri-$(BASE_VERSION)/resources/niri-session \
		debian/niri/usr/bin/niri-session

	# Install systemd service files
	install -vDm644 niri-$(BASE_VERSION)/resources/niri.service \
		debian/niri/usr/lib/systemd/user/niri.service
	install -vDm644 niri-$(BASE_VERSION)/resources/niri-shutdown.target \
		debian/niri/usr/lib/systemd/user/niri-shutdown.target

	# Install desktop session file
	install -vDm644 niri-$(BASE_VERSION)/resources/niri.desktop \
		debian/niri/usr/share/wayland-sessions/niri.desktop

	# Install portal configuration
	install -vDm644 niri-$(BASE_VERSION)/resources/niri-portals.conf \
		debian/niri/usr/share/xdg-desktop-portal/niri-portals.conf

	# Install documentation
	install -vDm644 niri-$(BASE_VERSION)/resources/default-config.kdl \
		debian/niri/usr/share/doc/niri/default-config.kdl
	install -vDm644 niri-$(BASE_VERSION)/README.md \
		debian/niri/usr/share/doc/niri/README.md

	# Install shell completions
	install -vDm644 niri-$(BASE_VERSION)/bash-completions \
		debian/niri/usr/share/bash-completion/completions/niri
	install -vDm644 niri-$(BASE_VERSION)/fish-completions \
		debian/niri/usr/share/fish/vendor_completions.d/niri.fish
	install -vDm644 niri-$(BASE_VERSION)/zsh-completions \
		debian/niri/usr/share/zsh/site-functions/_niri

override_dh_auto_clean:
	# Don't delete niri-$(BASE_VERSION) directory - it's part of the source package (native format)
	# Clean up cargo cache and build artifacts
	rm -rf .cargo
	if [ -d niri-$(BASE_VERSION) ]; then cd niri-$(BASE_VERSION) && cargo clean 2>/dev/null || true; fi
	dh_auto_clean

# Prevent dh_clean from removing .orig files in vendor directories
# This is critical for Rust packages with vendored dependencies
override_dh_clean:
	dh_clean -XCargo.toml.orig -X.orig
