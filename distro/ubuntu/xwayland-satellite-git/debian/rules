#!/usr/bin/make -f

export DH_VERBOSE = 1

%:
	dh $@

override_dh_auto_configure:
	# Source is included in source package (cloned by ppa-build.sh)
	if [ ! -d "xwayland-satellite-source" ]; then \
		echo "Error: xwayland-satellite-source directory not found!"; \
		echo "Source should be included in the source package."; \
		ls -la; \
		exit 1; \
	fi
	# Ensure .cargo/config.toml exists for vendored dependencies
	if [ ! -f "xwayland-satellite-source/.cargo/config.toml" ]; then \
		echo "Creating .cargo/config.toml for vendored sources"; \
		mkdir -p "xwayland-satellite-source/.cargo"; \
		echo '[source.crates-io]' > "xwayland-satellite-source/.cargo/config.toml"; \
		echo 'replace-with = "vendored-sources"' >> "xwayland-satellite-source/.cargo/config.toml"; \
		echo '' >> "xwayland-satellite-source/.cargo/config.toml"; \
		echo '[source.vendored-sources]' >> "xwayland-satellite-source/.cargo/config.toml"; \
		echo 'directory = "vendor"' >> "xwayland-satellite-source/.cargo/config.toml"; \
	fi

override_dh_auto_build:
	cd xwayland-satellite-source && \
	for checksum in vendor/*/.cargo-checksum.json; do \
		if [ -f "$$checksum" ]; then \
			pkg=$$(cat "$$checksum" | grep -o '"package":"[^"]*"' | cut -d'"' -f4); \
			echo "{\"files\":{},\"package\":\"$$pkg\"}" > "$$checksum"; \
		fi; \
	done && \
	cargo build --offline --release

override_dh_auto_install:
	install -Dm755 xwayland-satellite-source/target/release/xwayland-satellite \
		$(CURDIR)/debian/xwayland-satellite-git/usr/bin/xwayland-satellite

override_dh_auto_clean:
	# Don't remove .cargo - it contains config.toml needed for vendor
	if [ -d xwayland-satellite-source ]; then \
		cd xwayland-satellite-source && cargo clean 2>/dev/null || true; \
	fi
	dh_auto_clean
