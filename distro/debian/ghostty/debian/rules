#!/usr/bin/make -f

export HOME = $(CURDIR)
DEB_VERSION := $(shell dpkg-parsechangelog -S Version)
# Extract upstream version: remove Debian suffixes (.db[0-9] or db[0-9]) and ppa suffixes, then trim trailing dots/dashes
UPSTREAM_VERSION := $(shell echo $(DEB_VERSION) | sed -E 's/(\\.db|db)[0-9]+$$//' | sed 's/ppa[0-9]*$$//' | sed 's/[.-]$$//')
THEME_HASH := N-V-__8AANFEAwCzzNzNs3Gaq8pzGNl2BbeyFBwTyO5iZJL-

%:
	dh $@

override_dh_auto_configure:
	# Rewrite theme URL to local tarball and update hash (themes are vendored in source package)
	test -f ghostty-themes.tgz || (echo "ERROR: ghostty-themes.tgz not found!" && exit 1)
	# Update URL to file://
	sed -i "s#https://github.com/mbadolato[^\"]*ghostty-themes.tgz#file://$(CURDIR)/ghostty-themes.tgz#g" build.zig.zon build.zig.zon.json 2>/dev/null || true
	# Update hash to match the fixed themes tarball (required for file:// URLs)
	sed -i '/\.iterm2_themes/,/}/ s|\.hash = "[^"]*"|.hash = "$(THEME_HASH)"|' build.zig.zon 2>/dev/null || true
	sed -i '/"iterm2_themes"/,/\}/ s|"hash": "[^"]*"|"hash": "$(THEME_HASH)"|' build.zig.zon.json 2>/dev/null || true
	# Ensure vendored themes are extracted for offline builds
	mkdir -p "$(CURDIR)/zig-deps/p/$(THEME_HASH)"
	if [ -z "$$(ls -A "$(CURDIR)/zig-deps/p/$(THEME_HASH)" 2>/dev/null)" ]; then \
		tar -xzf ghostty-themes.tgz -C "$(CURDIR)/zig-deps/p/$(THEME_HASH)"; \
	fi
	# Rewrite wayland dependency URLs to local files (vendored in source package)
	test -f wayland.tar.gz || (echo "ERROR: wayland.tar.gz not found!" && exit 1)
	test -f wayland-protocols.tar.gz || (echo "ERROR: wayland-protocols.tar.gz not found!" && exit 1)
	test -f plasma_wayland_protocols.tar.gz || (echo "ERROR: plasma_wayland_protocols.tar.gz not found!" && exit 1)
	sed -i "s#https://deps.files.ghostty.org/wayland-9cb3d7aa9dc995ffafdbdef7ab86a949d0fb0e7d.tar.gz#file://$(CURDIR)/wayland.tar.gz#g" build.zig.zon 2>/dev/null || true
	sed -i "s#https://deps.files.ghostty.org/wayland-protocols-258d8f88f2c8c25a830c6316f87d23ce1a0f12d9.tar.gz#file://$(CURDIR)/wayland-protocols.tar.gz#g" build.zig.zon 2>/dev/null || true
	sed -i "s#https://deps.files.ghostty.org/plasma_wayland_protocols-12207e0851c12acdeee0991e893e0132fc87bb763969a585dc16ecca33e88334c566.tar.gz#file://$(CURDIR)/plasma_wayland_protocols.tar.gz#g" build.zig.zon 2>/dev/null || true
	dh_auto_configure

override_dh_auto_build:
	# Build using zig14 package with vendored dependencies
	ZIG_GLOBAL_CACHE_DIR=$(CURDIR)/zig-deps \
	DESTDIR=$(CURDIR)/debian/ghostty \
	/usr/bin/zig-0.14 build \
		--system $(CURDIR)/zig-deps/p \
		--prefix /usr \
		-Dversion-string=$(UPSTREAM_VERSION) \
		-Doptimize=ReleaseFast \
		-Dcpu=baseline \
		-Dpie=true

override_dh_auto_install:
	ZIG_GLOBAL_CACHE_DIR=$(CURDIR)/zig-deps \
	DESTDIR=$(CURDIR)/debian/ghostty \
	/usr/bin/zig-0.14 build install \
		--system $(CURDIR)/zig-deps/p \
		--prefix /usr \
		-Doptimize=ReleaseFast \
		-Dcpu=baseline
	# Flatten themes directory so files live directly under share/ghostty/themes
	if [ -d "$(CURDIR)/debian/ghostty/usr/share/ghostty/themes/ghostty" ]; then \
		mv "$(CURDIR)/debian/ghostty/usr/share/ghostty/themes/ghostty/"* $(CURDIR)/debian/ghostty/usr/share/ghostty/themes/ && \
		rmdir "$(CURDIR)/debian/ghostty/usr/share/ghostty/themes/ghostty"; \
	fi
	# Remove terminfo file that conflicts with ncurses-term (Ubuntu 25.04+)
	rm -f $(CURDIR)/debian/ghostty/usr/share/terminfo/g/ghostty

override_dh_auto_clean:
	rm -rf zig-cache zig-out .zig-cache
	dh_auto_clean
