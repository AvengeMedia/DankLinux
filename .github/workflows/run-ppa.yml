name: Update PPA Packages

on:
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to upload (cliphist, ghostty, matugen, niri, niri-git, quickshell, quickshell-git, xwayland-satellite, xwayland-satellite-git, or all)'
        required: false
        default: 'auto'
      force_upload:
        description: 'Force upload without version check'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      rebuild_release:
        description: 'Release number for rebuilds (e.g., 2, 3, 4 for ppa2, ppa3, ppa4)'
        required: false
        default: ''
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours (00:00, 06:00, 12:00, 18:00 UTC)

jobs:
  check-updates:
    name: Check for package updates
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      updated_packages: ${{ steps.check.outputs.updated_packages }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git

          # Install yq for reading pins.yaml
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Check for updates
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x distro/scripts/*.sh
          
          # Check for updates (PPA uses distro/ubuntu by default)
          UPDATED=$(distro/scripts/debian-update.sh 2>&1 | tee /dev/stderr | tail -1)
          
          if [ -n "$UPDATED" ] && [ "$UPDATED" != " " ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            # Convert space-separated to comma-separated for consistency
            UPDATED_CSV=$(echo "$UPDATED" | tr ' ' ',')
            echo "updated_packages=$UPDATED_CSV" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Updates found: $UPDATED"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "updated_packages=" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ No updates found"
          fi

  upload-ppa:
    name: Upload to PPA
    needs: check-updates
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    if: |
      github.event.inputs.force_upload == 'true' ||
      (needs.check-updates.outputs.has_updates == 'true' && needs.check-updates.outputs.updated_packages != '')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if last commit was automated
        id: check-loop
        run: |
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
          if [[ "$LAST_COMMIT_MSG" == "ci: Auto-update PPA packages"* ]] || [[ "$LAST_COMMIT_MSG" == "ci: Auto-update OBS packages"* ]]; then
            echo "â­ï¸ Last commit was automated ($LAST_COMMIT_MSG), skipping to prevent infinite loop"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Last commit was not automated, proceeding"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure Git
        if: steps.check-loop.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: Install build dependencies
        if: steps.check-loop.outputs.skip != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debhelper \
            devscripts \
            dput \
            lftp \
            build-essential \
            fakeroot \
            dpkg-dev
      
      - name: Configure GPG
        if: steps.check-loop.outputs.skip != 'true'
        env:
          GPG_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_KEY" | gpg --import
          GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | awk '{print $2}' | cut -d'/' -f2)
          echo "DEBSIGN_KEYID=$GPG_KEY_ID" >> $GITHUB_ENV
      
      - name: Determine packages to upload
        if: steps.check-loop.outputs.skip != 'true'
        id: packages
        run: |
          if [[ "${{ github.event.inputs.force_upload }}" == "true" ]]; then
            PKG="${{ github.event.inputs.package }}"
            if [[ "$PKG" == "auto" ]]; then
              PACKAGES="cliphist ghostty matugen niri niri-git quickshell quickshell-git xwayland-satellite xwayland-satellite-git"
            else
              PACKAGES="$PKG"
            fi
            echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
            echo "ðŸš€ Force upload: $PACKAGES"
          elif [[ -n "${{ github.event.inputs.package }}" && "${{ github.event.inputs.package }}" != "auto" ]]; then
            # Manual package selection should respect change detection
            SELECTED_PKG="${{ github.event.inputs.package }}"
            UPDATED_PKG="${{ needs.check-updates.outputs.updated_packages }}"

            # Check if manually selected package is in the updated list
            if [[ "$UPDATED_PKG" == *"$SELECTED_PKG"* ]]; then
              echo "packages=$SELECTED_PKG" >> $GITHUB_OUTPUT
              echo "ðŸ“¦ Manual selection (has updates): $SELECTED_PKG"
            else
              echo "packages=" >> $GITHUB_OUTPUT
              echo "âš ï¸ Manual selection '$SELECTED_PKG' has no updates - skipping (use force_upload to override)"
            fi
          elif [[ "${{ needs.check-updates.outputs.has_updates }}" == "true" ]]; then
            # Upload only updated packages
            UPDATED="${{ needs.check-updates.outputs.updated_packages }}"
            if [[ -n "$UPDATED" ]]; then
              # Convert comma-separated to space-separated
              PACKAGES=$(echo "$UPDATED" | tr ',' ' ')
              echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
              echo "âœ¨ Uploading updated packages: $PACKAGES"
            else
              PACKAGES="cliphist ghostty matugen niri niri-git quickshell quickshell-git xwayland-satellite xwayland-satellite-git"
              echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
            fi
          else
            PACKAGES="cliphist ghostty matugen niri niri-git quickshell quickshell-git xwayland-satellite xwayland-satellite-git"
            echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          fi

      - name: Upload to PPA
        if: steps.check-loop.outputs.skip != 'true'
        env:
          REBUILD_RELEASE: ${{ github.event.inputs.rebuild_release }}
        run: |
          PACKAGES="${{ steps.packages.outputs.packages }}"
          
          for pkg in $PACKAGES; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Uploading $pkg to PPA..."
            if [ -n "$REBUILD_RELEASE" ]; then
              echo "ðŸ”„ Using rebuild release number: ppa$REBUILD_RELEASE"
            fi
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            bash distro/scripts/ppa-upload.sh "$pkg" danklinux questing || echo "âš ï¸ Failed to upload $pkg"
          done
      
      - name: Get changed packages
        if: steps.check-loop.outputs.skip != 'true'
        id: changed-packages
        run: |
          # Check if there are any changelog changes to commit
          if git diff --exit-code distro/ubuntu/ >/dev/null 2>&1; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ No changelog changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # Get list of changed packages for commit message (deduplicate)
            CHANGED=$(git diff --name-only distro/ubuntu/ | grep 'debian/changelog' | sed 's|/debian/changelog||' | xargs -I{} basename {} | sort -u | tr '\n' ',' | sed 's/,$//')
            echo "packages=$CHANGED" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Changed packages: $CHANGED"
            echo "ðŸ“‹ Debug - Changed files:"
            git diff --name-only distro/ubuntu/ | grep 'debian/changelog' || echo "No changelog files found"
          fi

      - name: Commit changelog changes
        if: steps.check-loop.outputs.skip != 'true' && steps.changed-packages.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add distro/ubuntu/*/debian/changelog
          git commit -m "ci: Auto-update PPA packages [${{ steps.changed-packages.outputs.packages }}]" -m "ðŸ¤– Automated by GitHub Actions"
          git pull --rebase origin master
          git push
      
      - name: Summary
        run: |
          echo "### PPA Package Upload Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.check-updates.outputs.has_updates }}" == "true" ]]; then
            echo "- **Updated Packages**: ${{ needs.check-updates.outputs.updated_packages }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Uploaded Packages**: ${{ steps.packages.outputs.packages }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **PPA**: https://launchpad.net/~avengemedia/+archive/ubuntu/danklinux/+packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Builds will appear once Launchpad processes the uploads." >> $GITHUB_STEP_SUMMARY
