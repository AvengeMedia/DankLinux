name: Update OBS Packages

on:
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to upload (cliphist, ghostty, matugen, niri, niri-git, quickshell, quickshell-git, xwayland-satellite, xwayland-satellite-git, danksearch, dgop, or all)'
        required: false
        default: 'auto'
      force_upload:
        description: 'Force upload without version check'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      rebuild_release:
        description: 'Release number for rebuilds (e.g., 2, 3, 4 to increment spec Release)'
        required: false
        default: ''
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours (00:00, 06:00, 12:00, 18:00 UTC)

jobs:
  check-updates:
    name: Check for package updates
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      updated_packages: ${{ steps.check.outputs.updated_packages }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git
      
      - name: Update package versions
        id: update
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x distro/scripts/*.sh
          
          # Update debian/changelog files with latest upstream versions
          echo "ðŸ“¦ Updating Debian changelogs..."
          distro/scripts/debian-update.sh --update distro/debian
          
          # Update OpenSUSE spec files with latest upstream versions
          echo ""
          echo "ðŸ“¦ Updating OpenSUSE specs..."
          distro/scripts/opensuse-update.sh --update
      
      - name: Check for updates
        id: check
        run: |
          # Check if there are any changes in debian or opensuse directories
          DEBIAN_CHANGED=false
          OPENSUSE_CHANGED=false
          
          if ! git diff --exit-code distro/debian/ >/dev/null 2>&1; then
            DEBIAN_CHANGED=true
          fi
          
          if ! git diff --exit-code distro/opensuse/ >/dev/null 2>&1; then
            OPENSUSE_CHANGED=true
          fi
          
          if [ "$DEBIAN_CHANGED" = true ] || [ "$OPENSUSE_CHANGED" = true ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            
            # Get list of changed packages from both directories
            UPDATED_DEB=""
            UPDATED_SUSE=""
            
            if [ "$DEBIAN_CHANGED" = true ]; then
              UPDATED_DEB=$(git diff --name-only distro/debian/ | grep 'debian/changelog' | xargs dirname | xargs -I{} basename {} | tr '\n' ',' | sed 's/,$//')
            fi
            
            if [ "$OPENSUSE_CHANGED" = true ]; then
              UPDATED_SUSE=$(git diff --name-only distro/opensuse/ | sed 's/\.spec$//' | xargs -I{} basename {} | tr '\n' ',' | sed 's/,$//')
            fi
            
            # Combine and deduplicate
            ALL_UPDATED=$(echo "$UPDATED_DEB,$UPDATED_SUSE" | tr ',' '\n' | grep -v '^$' | sort -u | tr '\n' ',' | sed 's/,$//')
            echo "updated_packages=$ALL_UPDATED" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Updates found: $ALL_UPDATED"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "updated_packages=" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ No updates found"
          fi
      
      - name: Commit version updates
        if: steps.check.outputs.has_updates == 'true'
        run: |
          # Get changed packages for commit message
          CHANGED_DEB=$(git diff --name-only distro/debian/ 2>/dev/null | grep 'debian/changelog' | xargs dirname 2>/dev/null | xargs -I{} basename {} 2>/dev/null | tr '\n' ', ' | sed 's/, $//' || echo "")
          CHANGED_SUSE=$(git diff --name-only distro/opensuse/ 2>/dev/null | sed 's/\.spec$//' | xargs -I{} basename {} 2>/dev/null | tr '\n' ', ' | sed 's/, $//' || echo "")
          
          CHANGED=""
          [ -n "$CHANGED_DEB" ] && CHANGED="Debian: $CHANGED_DEB"
          [ -n "$CHANGED_SUSE" ] && [ -n "$CHANGED" ] && CHANGED="$CHANGED | "
          [ -n "$CHANGED_SUSE" ] && CHANGED="${CHANGED}OpenSUSE: $CHANGED_SUSE"
          
          # Build package list for commit message
          PKGS=$(echo "$CHANGED_DEB,$CHANGED_SUSE" | tr ',' '\n' | grep -v '^$' | sort -u | tr '\n' ',' | sed 's/,$//')
          
          git add distro/debian/ distro/opensuse/
          git commit -m "ci: Auto-update OBS packages [$PKGS]

          ðŸ¤– Automated by GitHub Actions"
          
          git push

  upload-obs:
    name: Upload to OBS
    needs: check-updates
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.force_upload == 'true' ||
      needs.check-updates.outputs.has_updates == 'true' ||
      github.event.inputs.package != 'auto'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0
      
      - name: Determine packages to upload
        id: packages
        run: |
          if [[ "${{ github.event.inputs.force_upload }}" == "true" ]]; then
            PKG="${{ github.event.inputs.package }}"
            if [[ "$PKG" == "auto" || -z "$PKG" ]]; then
              echo "packages=all" >> $GITHUB_OUTPUT
              echo "ðŸš€ Force upload: all packages"
            else
              echo "packages=$PKG" >> $GITHUB_OUTPUT
              echo "ðŸš€ Force upload: $PKG"
            fi
          elif [[ -n "${{ github.event.inputs.package }}" && "${{ github.event.inputs.package }}" != "auto" ]]; then
            echo "packages=${{ github.event.inputs.package }}" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Manual selection: ${{ github.event.inputs.package }}"
          elif [[ "${{ needs.check-updates.outputs.has_updates }}" == "true" ]]; then
            UPDATED="${{ needs.check-updates.outputs.updated_packages }}"
            if [[ -n "$UPDATED" ]]; then
              PACKAGES=$(echo "$UPDATED" | tr ',' ' ')
              echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
              echo "âœ¨ Uploading updated packages: $PACKAGES"
            else
              echo "packages=" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ Updates reported but no package list; skipping."
            fi
          else
            echo "packages=" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No updates detected and no manual trigger; nothing to upload."
          fi
      
      - name: Install OSC
        run: |
          sudo apt-get update
          sudo apt-get install -y osc
          
          mkdir -p ~/.config/osc
          cat > ~/.config/osc/oscrc << EOF
          [general]
          apiurl = https://api.opensuse.org
          
          [https://api.opensuse.org]
          user = ${{ secrets.OBS_USERNAME }}
          pass = ${{ secrets.OBS_PASSWORD }}
          EOF
          chmod 600 ~/.config/osc/oscrc
      
      - name: Upload to OBS
        env:
          FORCE_REBUILD: ${{ github.event_name == 'workflow_dispatch' && 'true' || '' }}
          REBUILD_RELEASE: ${{ github.event.inputs.rebuild_release }}
        run: |
          PACKAGES="${{ steps.packages.outputs.packages }}"

          if [[ -z "$PACKAGES" ]]; then
            echo "No packages selected for upload. Skipping." 
            exit 0
          fi

          # Loop through each package
          for pkg in $PACKAGES; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Uploading $pkg to OBS..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            bash distro/scripts/obs-upload.sh "$pkg" "Auto-update: $pkg" || echo "âš ï¸ Failed to upload $pkg"
          done
      
      - name: Summary
        run: |
          echo "### OBS Package Upload Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ -n "${{ steps.packages.outputs.packages }}" ]]; then
            echo "- **Uploaded Packages**: ${{ steps.packages.outputs.packages }}" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.check-updates.outputs.has_updates }}" == "true" ]]; then
            echo "- **Updated Packages**: ${{ needs.check-updates.outputs.updated_packages }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Uploaded Packages**: none (no updates detected)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **OBS Project**: https://build.opensuse.org/project/show/home:AvengeMedia:danklinux" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Builds will appear on OBS once processing completes." >> $GITHUB_STEP_SUMMARY
